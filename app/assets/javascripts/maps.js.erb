
$.support.cors = false;  // Delete this when origin control is added to CycleStreets API

var MapSearch = {
  geocoder_url: "<%= Geocoder::URL %>",
  geocoder_key: "<%= Geocoder::API_KEY %>",
  zoom: "<%= Geo::MAP_SEARCH_ZOOM %>",
  seqid: 0,
  map: null,

  set_map: function(map) {
    this.map = map;
  },

  projection: function() {
    return new OpenLayers.Projection("EPSG:4326");
  },

  search: function() {
    this.seqid++;
    var thiscall = this.seqid;
    var self = this;
    extents = this.map.getExtent().clone().transform(map.getProjectionObject(), this.projection());
    bbox = extents.left + ',' + extents.bottom + ',' + extents.right + ',' + extents.top
    params = [
      {name: 'q', value: $("#map-query").val()},
      {name: 'key', value: this.geocoder_key},
      {name: 'bbox', value: bbox},
      {name: 'geometries', value: 1}
    ]
    $.ajax({
        url: this.geocoder_url,
        data: params,
        dataType: ($.support.cors ? 'json' : 'jsonp'),
        timeout: 10000,
        success: function(response) {
          self.handle_result(response, thiscall);
        },
        error: this.handle_error
    });
    $("#map-search-status, #map-searching").show();
  },

  handle_result: function(response, call_seq) {
    $("#map-search-status, #map-searching").hide();
    // if not, then another search has been made since this one, so ignore
    if (call_seq != this.seqid) return false;
    if ($.isEmptyObject(response.features)) { // nothing found
      $("#map-search-noresult").show();
      return;
    }
    $("#map-search-noresult").hide();

    var results = response.features;
    var result = results[0];

    // Centre map on first result
    $('#map').trigger("zoomTo", [GeojsonBbox.bbox(result)]);
    $("#map-searching").hide();
    $("#map-search-main-result").
      find(".name").text(result.properties.name).end().
      find(".near").text(result.properties.near).end().
      show();

    // Display search results
    var list = $('<ol id="map-search-results"/>');
    $(results).each(function(i, item) {
      list.append(
        $('<li />').
          html("<a href='#'>" + item.properties.name + "(" + item.properties.near + ")" + "</a>").
          click(function() {
            $('#map').trigger("zoomTo", [GeojsonBbox.bbox(item)]);
            $("#map-search-main-result").
              find(".name").text(item.properties.name).end().
              find(".near").text(item.properties.near)
            return false;
          })
      );
    });
    $('#map-search-results').replaceWith(list).show();
  },

  handle_error: function() {
    $("#map-search-status, #map-searching").hide();
    $("#map-search-failed").show();
  }
}

$(function() {
  $("#map").bind("recenter", function(e, params) {
    var coords = new OpenLayers.LonLat(params.longitude, params.latitude).transform(MapSearch.projection(), map.getProjectionObject());
    map.setCenter(coords, params.zoom);
  });

  $("#map").bind("zoomTo", function(e, params) {
    var leftBottom = new OpenLayers.LonLat(params[0], params[1]).transform(MapSearch.projection(), map.getProjectionObject());
    var rightTop = new OpenLayers.LonLat(params[2], params[3]).transform(MapSearch.projection(), map.getProjectionObject());
    var bounds = new OpenLayers.Bounds([leftBottom.lon, leftBottom.lat, rightTop.lon, rightTop.lat]);
    map.zoomToExtent(bounds);
  });

  $(".map-search button").click(function() {
    MapSearch.set_map(map);  // This is bad
    MapSearch.search();
    return false;
  });
  $(".map-search input[type='text']").bind("keydown", function(e) {
    if (e.which == 13) {
      $(this).parent().find("button:first").click();
      return false;
    }
  });

  $("#map-search").bind("mouseenter", function(e) {
    $("#map-search-status").show();
  });
  $("#map-search-status").bind("mouseleave", function(e) {
    $(this).hide();
  });
});
